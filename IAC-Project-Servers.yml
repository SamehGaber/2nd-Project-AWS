AWSTemplateFormatVersion: 2010-09-09
Description: >
    Carlos Rivas / Udacity 2019

Parameters:

  EnvironmentName:
        Description: An environment name that will be prefixed to resource names
        Type: String
Resources:

    EC2SecGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
          GroupDescription: Allow http to our hosts and SSH from local only
          VpcId: 
           Fn::ImportValue:
            !Sub "${EnvironmentName}-VPCID"          
          SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 80
            ToPort: 80
            CidrIp: 0.0.0.0/0
          - IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            CidrIp: 0.0.0.0/0
          SecurityGroupEgress:
          - IpProtocol: tcp
            FromPort: 0
            ToPort: 65535
            CidrIp: 0.0.0.0/0

    WebAppLaunchConfig:
        Type: AWS::AutoScaling::LaunchConfiguration
        Properties:
         UserData:
          Fn::Base64: !Sub |
           #!/bin/bash
           sudo apt-get update -y
           sudo apt-get install unzip awscli -y
           sudo apt-get install apache2 -y
           sudo systemctl start apache2.service
        
         ImageId: ami-02701bcdc5509e57b #ubuntu image 
         IamInstanceProfile: !Ref ProfileWithRolesForOurApp
         KeyName: ms-lab
         SecurityGroups:
         - Ref: EC2SecGroup
         InstanceType: t2.micro  #free eligible t2.micro / t2.medium is the required
         BlockDeviceMappings:
         - DeviceName: "/dev/sdk"
           Ebs:
             VolumeSize: '10'
    
    WebAppTargetGroup:
        Type: AWS::ElasticLoadBalancingV2::TargetGroup
        Properties:
         HealthCheckIntervalSeconds: 10
         HealthCheckPath: /
         HealthCheckProtocol: HTTP
         HealthCheckTimeoutSeconds: 8
         HealthyThresholdCount: 2
         Port: 80
         Protocol: HTTP
         UnhealthyThresholdCount: 5
         VpcId:
           Fn::ImportValue:
            !Sub "${EnvironmentName}-VPCID"  

    WebAppGroup:
        Type: AWS::AutoScaling::AutoScalingGroup
        Properties:
         VPCZoneIdentifier: 
         - Fn::ImportValue: 
            !Sub  ${EnvironmentName}-PUB-NETS
         LaunchConfigurationName:
            Ref: WebAppLaunchConfig
         MinSize: '3'
         MaxSize: '5'
         TargetGroupARNs:
         - Ref: WebAppTargetGroup
    
    UdacityS3ReadOnlyEC2:
     Type: AWS::IAM::Role
     Properties:
      AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Principal: 
              Service: 
                - "ec2.amazonaws.com"
            Action: 
              - 'sts:AssumeRole'
      ManagedPolicyArns:
         - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore

    ProfileWithRolesForOurApp:
     Type: AWS::IAM::InstanceProfile
     Properties: 
        Path: "/"
        Roles:
          - Ref: UdacityS3ReadOnlyEC2  